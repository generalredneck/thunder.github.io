<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.33">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/thunder.svg"><title>Tag-based cache invalidation for Varnish | Thunder</title><meta name="description" content="Thunder is a Drupal distribution for professional publishers.">
    <link rel="modulepreload" href="/assets/app.e4b5da82.js"><link rel="modulepreload" href="/assets/varnish.html.c223dad3.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/varnish.html.021bd9e2.js">
    <link rel="stylesheet" href="/assets/style.f03665c5.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><svg class="logo" version="1.1" id="Ebene_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 492 110.7" enable-background="new 0 0 492 110.7" xml:space="preserve"><g><path class="light" fill="#009FE3" d="M26.9,107c1.9,0.3,3.9,0.5,5.7,0.6c1.9,0.1,3.7,0.1,5.3,0.1c1.6,0,3.3-0.1,5.1-0.2c1.7-0.1,3.5-0.3,5.2-0.5
		V20.5h26c0.6-2.9,0.9-6,0.9-9.2c0-3-0.3-6-0.9-8.9H0.9C0.3,5.4,0,8.3,0,11.3c0,3.2,0.3,6.3,0.9,9.2h26V107L26.9,107z M80.9,107.2
		c1.7,0.3,3.5,0.5,5.2,0.6c1.7,0.1,3.4,0.1,5,0.1c1.6,0,3.3,0,5.1-0.1c1.7-0.1,3.5-0.3,5.2-0.6V67.6c0-4.1,0.5-7.4,1.4-9.9
		c0.9-2.5,2.1-4.5,3.5-5.9c1.4-1.4,3-2.4,4.7-2.8c1.7-0.5,3.4-0.7,5.1-0.7c4,0,6.8,1.4,8.4,4.2c1.6,2.8,2.5,6.8,2.5,12.1v42.6
		c1.7,0.3,3.5,0.5,5.2,0.6c1.7,0.1,3.4,0.1,5.1,0.1c1.6,0,3.3,0,5.1-0.1c1.7-0.1,3.5-0.3,5.2-0.6V59c0-10-2.2-17.3-6.5-22
		c-4.3-4.7-10.6-7-19-7c-3,0-5.7,0.4-8,1.2c-2.3,0.8-4.3,1.7-6,2.8c-1.6,1.1-3,2.3-4.1,3.5c-1.1,1.2-2,2.3-2.7,3.1V2
		c-1.7-0.3-3.5-0.5-5.2-0.6c-1.7-0.1-3.4-0.1-5.1-0.1c-1.7,0-3.3,0-5.1,0.1c-1.7,0.1-3.4,0.3-5.1,0.6V107.2L80.9,107.2z M337.8,31.6
		c-1.7-0.5-3.6-0.8-5.5-0.9c-1.9-0.1-3.7-0.2-5.5-0.2c-5.8,0-11.1,1-15.9,3.1c-4.8,2.1-8.8,4.9-12.1,8.5c-3.3,3.6-5.9,7.8-7.7,12.7
		c-1.8,4.9-2.7,10.1-2.7,15.6c0,7,1,12.9,3.1,17.7c2.1,4.8,4.9,8.8,8.5,11.9c3.6,3.1,7.7,5.3,12.4,6.7c4.7,1.4,9.6,2.1,14.8,2.1
		c6.7,0,12.4-0.4,17.1-1.1c4.7-0.7,9.3-1.8,13.9-3.1V0.7c-1.7-0.3-3.5-0.5-5.2-0.6C351.3,0,349.6,0,348,0c-1.6,0-3.3,0-5,0.1
		c-1.7,0.1-3.4,0.3-5.2,0.6V31.6L337.8,31.6z M337.8,90.6c-1.6,0.5-3.2,0.8-4.5,0.9c-1.4,0.1-2.9,0.2-4.5,0.2
		c-2.7,0-5.2-0.4-7.6-1.1c-2.3-0.7-4.3-1.9-6-3.6c-1.7-1.6-3-3.9-4-6.6c-1-2.8-1.5-6.1-1.5-10.1c0-3.2,0.4-6.3,1.1-9.2
		c0.7-3,1.9-5.5,3.4-7.7c1.6-2.2,3.5-3.9,5.9-5.2c2.4-1.3,5.2-2,8.4-2c1.8,0,3.4,0.1,4.6,0.2c1.2,0.1,2.8,0.5,4.7,0.9V90.6
		L337.8,90.6z M435.2,75.8c0.2-1.1,0.4-2.5,0.5-4.3c0.1-1.8,0.2-3.6,0.2-5.5c0-5-0.7-9.8-2.2-14.2c-1.5-4.4-3.6-8.2-6.5-11.4
		c-2.9-3.2-6.3-5.7-10.4-7.6c-4.1-1.8-8.7-2.8-14-2.8c-6,0-11.3,1-15.8,3.1c-4.5,2.1-8.3,4.9-11.3,8.5c-3.1,3.6-5.4,7.8-6.9,12.7
		c-1.6,4.9-2.3,10-2.3,15.6c0,5.6,0.8,10.8,2.3,15.6c1.5,4.8,3.8,8.8,7,12.3c3.1,3.4,7.2,6.1,12.2,8.1c5,1.9,13.8,2.9,20.8,2.9
		c9.5,0,15.2-1.5,22.8-4.4c-0.1-3.1-0.5-6-1.3-8.7c-0.8-2.7-1.7-5-2.8-7c-3.1,1.2-6.4,2.1-9.8,2.7c-3.4,0.6-6.8,0.9-10.1,0.9
		c-6,0-10.9-1.3-14.5-3.9c-3.7-2.6-5.7-6.8-6.1-12.7H435.2L435.2,75.8z M387.1,61.4c0.5-4.9,2-8.8,4.5-11.5
		c2.5-2.7,6.2-4.1,11.1-4.1c4.3,0,7.6,1.4,10,4.3c2.4,2.9,3.7,6.6,3.9,11.3H387.1L387.1,61.4z M446.6,107.2c1.8,0.3,3.6,0.5,5.3,0.6
		c1.7,0.1,3.4,0.1,5,0.1c1.6,0,3.3,0,5.1-0.1c1.7-0.1,3.5-0.3,5.2-0.6V71.4c0-5.2,0.6-9.3,1.8-12.2c1.2-2.9,2.7-5.1,4.6-6.5
		c1.8-1.5,3.8-2.4,5.8-2.7c2-0.3,3.9-0.5,5.5-0.5c0.3,0,1.1,0,2.4,0c1.3,0,2.5,0.1,3.6,0.3c0.4-1.7,0.7-3.6,0.8-5.5
		c0.1-1.9,0.2-3.7,0.2-5.4c0-1.4,0-2.7-0.1-3.9c-0.1-1.3-0.2-2.4-0.4-3.3c-0.6-0.2-1.5-0.3-2.8-0.4c-1.3-0.1-2.4-0.1-3.3-0.1
		c-4.7,0-8.5,1.2-11.6,3.6c-3.1,2.4-5.7,5.1-7.9,8.1c-0.1-0.7-0.2-1.5-0.4-2.5c-0.1-1-0.3-2-0.5-3.1c-0.2-1-0.4-2-0.7-2.9
		c-0.2-0.9-0.5-1.6-0.8-2.1c-1.4-0.3-2.7-0.5-4.1-0.7c-1.4-0.2-2.8-0.3-4.3-0.3c-1.6,0-3,0.1-4.3,0.2s-2.7,0.4-4.1,0.7V107.2
		L446.6,107.2z"></path><path class="dark" fill="#A2DAF8" d="M244.6,110.5c-20.6,0-30.4-12.3-32.5-17.1c-1.8-4.4-2.8-10-3-17l0,0v-2c0-0.1,0-0.3,0-0.4v-7
		c0-3.8-0.3-7-0.9-9.5c-0.6-2.6-1.6-4.6-2.9-6.1c-1.3-1.5-2.9-2.6-4.9-3.2c-1.9-0.6-4.2-0.9-6.8-0.9c-2.6,0-4.9,0.3-6.8,0.9
		c-1.9,0.6-3.6,1.7-4.9,3.2c-1.3,1.5-2.3,3.5-2.9,6.1c-0.6,2.6-0.9,5.8-0.9,9.8v39.8c-0.1,0-0.2,0-0.3,0c-3.4,0-6.5-8.3-9.8-8.3
		c-3.4,0-7-22.9-10.5-23.5v-8.6c0-8,1-14.5,3.1-19.3c2-4.8,10.4-8.5,13.9-11c3.4-2.5,6.9-6.1,19.9-6.1c20.6,0,30.4,12.3,32.5,17.1
		c1.8,4.4,2.8,10,3,17l0,0v2c0,0.1,0,0.3,0,0.4v7c0,3.8,0.3,7,0.9,9.5c0.6,2.6,1.6,4.6,2.9,6.1c1.3,1.5,2.9,2.6,4.9,3.2
		c1.9,0.6,4.2,0.9,6.8,0.9c2.6,0,4.9-0.3,6.8-0.9c1.9-0.6,3.6-1.7,4.9-3.2c1.3-1.5,2.3-3.5,2.9-6.1c0.6-2.6,0.9-5.8,0.9-9.8V33.7
		c0.1,0,0.2,0,0.3,0c3.4,0,6.5,8.3,9.8,8.3c3.4,0,7,22.9,10.5,23.5v8.6c0,8-1,14.5-3.1,19.3c-2,4.8-10.4,8.5-13.9,11
		C261,107,257.6,110.5,244.6,110.5"></path><path class="light" fill="#009FE3" d="M281.4,107V66.6c0-8-1-14.5-3.1-19.3c-2-4.8-4.8-8.5-8.2-11c-3.4-2.5-7.4-4.2-12-4.9
		c-4.1-0.7-8.5-1-12.9-1.1c-4.5,0.1-8.8,0.4-12.9,1.1c-4.6,0.8-8.6,2.4-12,4.9c-3.4,2.5-6.2,6.2-8.2,11c-2,4.8-3.1,11.3-3.1,19.3V74
		c0,3.8-0.3,7-0.9,9.5c-0.6,2.6-1.6,4.6-2.9,6.1c-1.3,1.5-2.9,2.6-4.9,3.2c-1.9,0.6-4.2,0.9-6.8,0.9c-2.6,0-4.9-0.3-6.8-0.9
		c-1.9-0.6-3.6-1.7-4.9-3.2c-1.3-1.5-2.3-3.5-2.9-6.1c-0.6-2.6-0.9-5.8-0.9-9.8V33.9c-3.5-0.6-6.9-0.9-10.3-0.9
		c-3.4,0-6.8,0.3-10.3,0.9v40.4c0,8,1,14.5,3.1,19.3c2,4.8,4.8,8.5,8.2,11c3.4,2.5,7.4,4.2,12,4.9c4.1,0.7,8.5,1,12.9,1.1
		c4.5-0.1,8.8-0.4,12.9-1.1c4.6-0.8,8.6-2.4,12-4.9c3.4-2.5,6.2-6.2,8.2-11c1.9-4.4,2.9-10.3,3-17.4l0,0v-1.5c0-0.1,0-0.3,0-0.4l0,0
		v-7.1c0-4,0.3-7.2,0.9-9.8c0.6-2.6,1.6-4.6,2.9-6.1c1.3-1.5,2.9-2.6,4.9-3.2c1.9-0.6,4.2-0.9,6.8-0.9c2.6,0,4.9,0.3,6.8,0.9
		c1.9,0.6,3.6,1.7,4.9,3.2c1.3,1.5,2.3,3.5,2.9,6.1c0.6,2.6,0.9,5.8,0.9,9.8V107c3.5,0.6,6.9,0.9,10.3,0.9
		C274.5,107.9,277.9,107.6,281.4,107L281.4,107z"></path></g></svg><span class="site-name can-hide">Thunder</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/user-guide/feature-overview.html" class="" aria-label="User Guide"><!--[--><!--]--> User Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/developer-guide/setup.md" class="" aria-label="Developer Guide"><!--[--><!--]--> Developer Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/contributing.md" class="" aria-label="Contribute"><!--[--><!--]--> Contribute <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://thunder.org" rel="noopener noreferrer" target="_blank" aria-label="Thunder.org"><!--[--><!--]--> Thunder.org <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/thunder/thunder-distribution" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/user-guide/feature-overview.html" class="" aria-label="User Guide"><!--[--><!--]--> User Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/developer-guide/setup.md" class="" aria-label="Developer Guide"><!--[--><!--]--> Developer Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/contributing.md" class="" aria-label="Contribute"><!--[--><!--]--> Contribute <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://thunder.org" rel="noopener noreferrer" target="_blank" aria-label="Thunder.org"><!--[--><!--]--> Thunder.org <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/thunder/thunder-distribution" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/developer-guide/setup.html" class="sidebar-item sidebar-heading" aria-label="Setup Thunder"><!--[--><!--]--> Setup Thunder <!--[--><!--]--></a><!----></li><li><p class="sidebar-item sidebar-heading active">Operating <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/developer-guide/operating/varnish.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Tag-based cache invalidation for Varnish"><!--[--><!--]--> Tag-based cache invalidation for Varnish <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/developer-guide/operating/varnish.html#requirements" class="router-link-active router-link-exact-active sidebar-item" aria-label="Requirements"><!--[--><!--]--> Requirements <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/developer-guide/operating/varnish.html#setup-varnish" class="router-link-active router-link-exact-active sidebar-item" aria-label="Setup Varnish"><!--[--><!--]--> Setup Varnish <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/developer-guide/operating/varnish.html#install-drupal-purge-modules" class="router-link-active router-link-exact-active sidebar-item" aria-label="Install Drupal Purge modules"><!--[--><!--]--> Install Drupal Purge modules <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/developer-guide/operating/varnish.html#setup-drupal-site-to-use-purge" class="router-link-active router-link-exact-active sidebar-item" aria-label="Setup Drupal site to use Purge"><!--[--><!--]--> Setup Drupal site to use Purge <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/developer-guide/operating/varnish.html#steps-of-integration-on-a-live-system-with-existing-varnish" class="router-link-active router-link-exact-active sidebar-item" aria-label="Steps of integration on a live system with existing Varnish"><!--[--><!--]--> Steps of integration on a live system with existing Varnish <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/developer-guide/operating/varnish.html#clearing-and-rebuilding-of-cache" class="router-link-active router-link-exact-active sidebar-item" aria-label="Clearing and rebuilding of cache"><!--[--><!--]--> Clearing and rebuilding of cache <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a href="/developer-guide/testing.html" class="sidebar-item sidebar-heading" aria-label="Testing"><!--[--><!--]--> Testing <!--[--><!--]--></a><!----></li><li><a href="/developer-guide/headless.html" class="sidebar-item sidebar-heading" aria-label="Headless API"><!--[--><!--]--> Headless API <!--[--><!--]--></a><!----></li><li><p class="sidebar-item sidebar-heading">Migration <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/developer-guide/migration/migrate-3-6.html" class="sidebar-item" aria-label="Update Thunder 3 -&gt; Thunder 6"><!--[--><!--]--> Update Thunder 3 -&gt; Thunder 6 <!--[--><!--]--></a><!----></li><li><a href="/developer-guide/migration/migrate-2-3.html" class="sidebar-item" aria-label="Update Thunder 2 -&gt; Thunder 3"><!--[--><!--]--> Update Thunder 2 -&gt; Thunder 3 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p class="sidebar-item sidebar-heading">Changelogs <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/changelog/6.3.x" class="sidebar-item" aria-label="Changelog 6.3.x"><!--[--><!--]--> Changelog 6.3.x <!--[--><!--]--></a><!----></li><li><a href="/changelog/6.2.x" class="sidebar-item" aria-label="Changelog 6.2.x"><!--[--><!--]--> Changelog 6.2.x <!--[--><!--]--></a><!----></li><li><a href="/changelog/6.1.x" class="sidebar-item" aria-label="Changelog 6.1.x"><!--[--><!--]--> Changelog 6.1.x <!--[--><!--]--></a><!----></li><li><a href="/changelog/6.0.x" class="sidebar-item" aria-label="Changelog 6.0.x"><!--[--><!--]--> Changelog 6.0.x <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="tag-based-cache-invalidation-for-varnish" tabindex="-1"><a class="header-anchor" href="#tag-based-cache-invalidation-for-varnish" aria-hidden="true">#</a> Tag-based cache invalidation for Varnish</h1><p>This is a guide on how to set up Varnish to use effective cache invalidation. The idea behind it is that cache tags provided by Drupal are used to invalidate the cache (sometimes this action will be called &quot;purge&quot; in the following documentation). To achieve tag-based cache invalidation a few modules have to be installed and configured to work in combination with customized cache invalidation subroutines provided for Varnish.</p><h2 id="requirements" tabindex="-1"><a class="header-anchor" href="#requirements" aria-hidden="true">#</a> Requirements</h2><ol><li><a href="https://varnish-cache.org" target="_blank" rel="noopener noreferrer">Varnish service<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://www.drupal.org/project/purge" target="_blank" rel="noopener noreferrer">Purge Drupal module<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ol><h2 id="setup-varnish" tabindex="-1"><a class="header-anchor" href="#setup-varnish" aria-hidden="true">#</a> Setup Varnish</h2><p>To install Varnish on your platform you can follow the installation and configuration tutorial provided on <a href="https://www.varnish-software.com/wiki/content/tutorials/varnish/varnish_ubuntu.html" target="_blank" rel="noopener noreferrer">Varnish Wiki<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>. On the same Wiki site, you can find several helpful examples of <a href="https://www.varnish-software.com/wiki/content/tutorials/drupal/drupal_vcl.html" target="_blank" rel="noopener noreferrer">Varnish configurations relevant for Drupal<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> .</p><p>All code examples provided in this documentation should be placed in a Varnish script file. By default Varnish uses <code>/etc/varnish/default.vcl</code>, but on different platforms, the VCL script file can be placed in another location.</p><p>The first step is to set up Varnish to accept commands provided by the Purge module. At first, we will add the list of servers (IPs) that are allowed to do cache invalidation. Those are usually your Drupal servers. The reason for whitelisting Drupal servers is to avoid possible DOS attacks from public IP addresses. At the beginning of the Varnish script file the following code should be added:</p><div class="language-varnish ext-varnish line-numbers-mode"><pre class="language-varnish"><code># Whitelist of Purger servers.
acl whitelisted_purgers {
    &quot;127.0.0.1&quot;;
    # Add any other IP addresses that your Drupal runs on and that you
    # want to allow cache invalidation requests from. For example:
    # &quot;192.168.1.0&quot;/24;
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The provided example will whitelist only the localhost server to do invalidation of cache.</p><p>After that, we need to add a script that will actually handle cache invalidation. Following script code should be added in <code>vcl_recv</code> subroutine:</p><div class="language-varnish ext-varnish line-numbers-mode"><pre class="language-varnish"><code># Only allow BAN requests from whitelisted IP addresses, listed in the &#39;whitelisted_purgers&#39; ACL.
if (req.method == &quot;BAN&quot;) {
  # Check is client IP whitelisted for cache invalidation.
  if (!client.ip ~ whitelisted_purgers) {
    return (synth(403, &quot;Not allowed.&quot;));
  }

  # Logic for the ban, using the Purge-Cache-Tags header. For more info
  # see https://github.com/geerlingguy/drupal-vm/issues/397.
  if (req.http.Purge-Cache-Tags) {
    ban(&quot;obj.http.Purge-Cache-Tags ~ &quot; + req.http.Purge-Cache-Tags);
  }
  else {
    return (synth(403, &quot;Purge-Cache-Tags header missing.&quot;));
  }

  # Throw a synthetic page so the request won&#39;t go to the backend.
  return (synth(200, &quot;Ban added.&quot;));
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>The following script will accept &quot;BAN&quot; commands from the Drupal Purge module and process them accordingly.</p><p>Since <code>Purge-Cache-Tags</code> header tends to be quite big, it would be wise to remove it from the response before it&#39;s sent to the user&#39;s browser. That can be achieved by adding following code in <code>vcl_deliver</code> subroutine:</p><div class="language-varnish ext-varnish line-numbers-mode"><pre class="language-varnish"><code>  # Purge&#39;s headers can become quite big, so they should be cleaned before the response is returned.
  unset resp.http.Purge-Cache-Tags;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>After these changes, varnish can be restarted and it&#39;s ready to accept cache invalidation requests from the Drupal Purge module.</p><h2 id="install-drupal-purge-modules" tabindex="-1"><a class="header-anchor" href="#install-drupal-purge-modules" aria-hidden="true">#</a> Install Drupal Purge modules</h2><p>The purge module provides functionality to expose cache tags in the header of the response. Varnish by default will keep the header saved for every cache entry and that information will be used later to invalidate cache entries.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">composer</span> require drupal/purge drupal/purge_purger_http
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>After that enable following modules:</p><ul><li>Purge (purge) - base Purge module</li><li>Purge Tokens (purge_tokens) - required to replace generic cache tag tokens</li><li>Purge UI (purge_ui) - user interface for Purge configuration pages</li><li>Late runtime processor (purge_processor_lateruntime) - purge process, it will trigger cache invalidation on any core cache invalidation (fe. article save, media entity save, etc.)</li><li>Core tags queuer (purge_queuer_coretags) - provides queue core cache tag invalidation</li><li>Generic HTTP Purger (purge_purger_http) - makes BAN request, to execute cache invalidation for Varnish</li><li>Generic HTTP Tags Header (purge_purger_http_tagsheader) - exposes required header for Varnish</li></ul><p>To enable modules over drush, execute following command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>drush en purge, purge_tokens, purge_ui, purge_processor_lateruntime, purge_queuer_coretags, purge_purger_http, purge_purger_http_tagsheader
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>After these modules are enabled, Drupal should provide the <code>Purge-Cache-Tags</code> header. That header property contains all cache tags for the loaded page.</p><h2 id="setup-drupal-site-to-use-purge" tabindex="-1"><a class="header-anchor" href="#setup-drupal-site-to-use-purge" aria-hidden="true">#</a> Setup Drupal site to use Purge</h2><p>On the Drupal site open: Configuration -&gt; Development -&gt; Performance page (<code>admin/config/development/performance</code>). Enable caching and set it high, ideally max period (1 year). Save configuration and after that open Purge configuration page (<code>admin/config/development/performance/purge</code>).</p><p>On that page do the following configuration:</p><ol><li>Click &quot;Add Purger&quot;</li><li>Choose &quot;HTTP Bundled Purger&quot;</li><li>Click &quot;Add&quot;</li><li>HTTP Bundled Purger will be added with a generic name</li><li>Click the drop-down button and choose &quot;Configure&quot;</li><li>Set &quot;Name&quot; for Purger (e.g. Varnish Bundled HTTP Purger)</li><li>Adjust Hostname and Port to match your Varnish server</li><li>Click &quot;Headers&quot;</li><li>Create Header - Name: <code>Purge-Cache-Tags</code> - Value: <code>[invalidations:separated_pipe]</code></li><li>Click &quot;Save Configuration&quot;</li></ol><p>With this created Purger for Varnish, everything should work.</p><h2 id="steps-of-integration-on-a-live-system-with-existing-varnish" tabindex="-1"><a class="header-anchor" href="#steps-of-integration-on-a-live-system-with-existing-varnish" aria-hidden="true">#</a> Steps of integration on a live system with existing Varnish</h2><p>On live system integration can be done in the following order:</p><ol><li>Modify the existing Varnish script and reload it without losing currently cached pages. Here is a guide <a href="https://ma.ttias.be/reload-varnish-vcl-without-losing-cache-data" target="_blank" rel="noopener noreferrer">how to reload it<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</li><li>Install Purge modules and enable them (after this step Varnish will receive requests with <code>Purge-Cache-Tags</code> header and collect them).</li><li>Add purger for tag-based cache invalidation as it&#39;s explained in the documentation.</li><li>The last step should be to increase caching time to maximum (already cached pages will be invalidated over time and tag-based cache invalidation will take over).</li></ol><h2 id="clearing-and-rebuilding-of-cache" tabindex="-1"><a class="header-anchor" href="#clearing-and-rebuilding-of-cache" aria-hidden="true">#</a> Clearing and rebuilding of cache</h2><p>If you want to clear all cache on your site and rebuild it, the most common way is to use <code>drush cache-rebuild</code> command, but currently, that command will not trigger Purger, and Varnish will still keep old cached pages. If you clear cache over the user interface in administration page: Configuration -&gt; Development -&gt; Performance (<code>admin/config/development/performance</code>), then also Varnish cache will be properly invalidated. To use <code>drush</code> command for Varnish cache invalidation, one additional module has to be installed:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>drush en purge_drush
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>After that it&#39;s possible to use the following combination of commands to clear all cache in Drupal site and Varnish:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>drush cache-rebuild

drush p-invalidate tag <span class="token string">&#39;.+&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/thunder/thunder-distribution/edit/6.3.x/docs/developer-guide/operating/varnish.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.e4b5da82.js" defer></script>
  </body>
</html>
